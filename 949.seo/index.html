<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>链路劫持攻击一二三 | Blog of Secer</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="Blog of Secer">

  
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Blog of Secer</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2012-12-04T23:11:25.000Z" itemprop="datePublished">
          2012-12-05
      </time>
    
    
    | 
    <a href='/tag/漏洞/'>漏洞</a>,
    
    <a href='/tag/TCP链路劫持/'>TCP链路劫持</a>,
    
    <a href='/tag/ARP/'>ARP</a>
    
    
</span>
    <h1 class="post-title">链路劫持攻击一二三</h1>
    <section class="post-content">
      <p>博文作者：lake2 [ TSRC ]</p>  <p>发布日期：2012-11-09</p>  <p>博文内容：</p>  <p>随着应用安全的发展，大家都比较关注应用安全<a href="http://ha.cker.in/tag/漏洞" target="_blank">漏洞</a>，其实在应用层之下的传输层也有很多安全风险，而且这些安全风险正在被广泛利用。比如今天要给大家介绍的TCP链路劫持攻击。</p>  <p><a href="http://ha.cker.in/tag/TCP链路劫持" target="_blank">TCP链路劫持</a>其实就是指网络链路上侦听、伪造TCP包，达到控制目标网络链路的行为。最常见的就是某些设备实现的对非法站点的访问拦截，以及一些地区运营商的网页植入广告行为。</p>  <p>因为广域网的链路劫持影响面大，一般会影响一个地区甚至是全国，所以本文重点讨论广域网的TCP链路劫持，局域网的劫持如<a href="http://ha.cker.in/tag/ARP" target="_blank">ARP</a>攻击不在讨论范围。</p>  <p>目前发现的TCP链路劫持攻击一般有两种形式：中断访问型（分为单向发包和双向发包）和替换页面型。</p>  <p>中断访问型常见于阻止用户访问某些网站，如某些设备禁止用户访问某些站点、某地运营商的禁止ADSL多终端上网功能。其原理就是伪造服务端给用户发RST包阻止TCP连接的建立（单向发包）。某些设备做得比较狠，在冒充服务端给用户发RST包的同时也冒充用户给服务端发RST包（双向发包）。</p>  <p>替换页面型常见于运营商植入广告，也有篡改正常网页进行SEO、骗流量的。笔者见过最恶劣的莫过于钓鱼，如2011年出现过的Gmail<a href="http://ha.cker.in/tag/钓鱼" target="_blank">钓鱼</a>事件以及一些不能告诉你的钓鱼事件。原理也简单，就是在一个HTTP请求后伪造服务端的HTTP响应给客户端。</p>  <p>如下图所示就是一次典型的TCP链路劫持替换页面，我们可以看到，TCP三次握手完成后，HTTP请求包发送后，客户端收到两个HTTP响应包，因为伪造的第一个包（10号）先到，所以第二个正常的HTTP响应包（13号）被客户端忽略了。很明显，在网络上有一个设备，侦听整个会话，当匹配某个特征就抢先发包劫持会话。</p>  <p><a href="http://img.cker.in/df83baa6d2dd_D57E/clip_image001.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="clip_image001" border="0" alt="clip_image001" src="http://img.cker.in/df83baa6d2dd_D57E/clip_image001_thumb.png" width="863" height="179"></a></p>  <p>这些利用链路劫持进行的弹窗广告、“技术问题”产生的误拦截、植入代码不慎将页面弄乱、甚至是钓鱼等将会损害用户利益。笔者跟链路劫持的“不解之缘”就因此而起。</p>  <p>要解决链路劫持先要搞清楚是否是链路劫持，如是则出问题的大概位置在哪里。链路劫持是区域性的，一般来讲某地区用户集中投诉，就可以联系用户调查了。用户往往不懂Wireshark抓包，还要远程协助，如果网速慢就是悲剧……各种心酸且按下不表。</p>  <p>抓到可疑包之后关注两个关键点：TTL值和IP Id（Identification）。根据实际观测，伪造的TCP包的TTL值和Id是不符合逻辑的。</p>  <p>比如下图，真实包的TTL是53，Id是按顺序自增的，而伪造的包的TTL是64，Id始终是0。还有，笔者也见过某地运营商禁止ADSL多终端上网功能会伪造Id值恒为8888的RST包。</p>  <p><a href="http://img.cker.in/df83baa6d2dd_D57E/clip_image002.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="clip_image002" border="0" alt="clip_image002" src="http://img.cker.in/df83baa6d2dd_D57E/clip_image002_thumb.png" width="440" height="202"></a></p>  <p><a href="http://img.cker.in/df83baa6d2dd_D57E/clip_image003.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="clip_image003" border="0" alt="clip_image003" src="http://img.cker.in/df83baa6d2dd_D57E/clip_image003_thumb.png" width="390" height="194"></a></p>  <p>通过伪造的TTL值就可以大致定位侦听设备的位置。利用伪造的数据包的TTL值加上当时用户的路由即可定位：数据包每经过一个路由TTL值就会减一，我们找到假的包，看他的TTL（一般初始发出的TTL是256或128或64）减了多少，反推回去就找到出问题的位置了。</p>  <p>刚刚那个截图，伪造的的TCP包TTL值是64，也就是可以推测出链路劫持就发生在局域网内。的确如此，这个case是一个路由器软件进行链路劫持的案例。</p>  <p>有个问题，如果攻击者聪明一些，伪造包定制一个TTL值，就会导致我们难以精确定位。比如某些设备会发三次RST包，每次的TTL都不一样。注意，我说的“难以定位”并非“不能定位”，还是有办法的，需要动动脑子。</p>  <p>坏人是很多的，不能每次都被动等待用户投诉，如何主动发现链路劫持呢？</p>  <p>客户端访问目标站点的时候，同一个TCP会话的TTL值发生较大变动，就可以判定为疑似劫持。以下python代码就是一个利用Scapy检测TCP链路劫持的示例：</p>  <pre>#!/bin/python<br><br>#<br><br>#<br><br><span style="color: #0000ff">import</span> <span style="color: #0000ff">sys</span><br><br>from scapy.all <span style="color: #0000ff">import</span> *<br><br>conf.verb=0<br><br><span style="color: #0000ff">print</span> &quot;<span style="color: #8b0000">TCP Hijacking Delector by lake2</span>&quot;<br><br><span style="color: #0000ff">print</span> &quot;<span style="color: #8b0000">[+] Sniffing ….</span>&quot;<br><br>ip_arr = {}<br><br>while 1:<br><br>a=sniff( filter=&quot;<span style="color: #8b0000">tcp and src host not 10.26.234.44</span>&quot;, <span style="color: #0000ff">count</span>=50)<br><br>for b in a:<br><br>ip_src = b.sprintf(r&quot;<span style="color: #8b0000">%IP.src%</span>&quot;)<br><br>ip_ttl = b.sprintf(r&quot;<span style="color: #8b0000">%IP.ttl%</span>&quot;)<br><br><span style="color: #0000ff">if</span> ip_arr.has_key(ip_src):<br><br>c = int(ip_ttl) - int(ip_arr[ip_src])<br><br><span style="color: #0000ff">if</span> <span style="color: #0000ff">abs</span>(c) &gt; 4:<br><br><span style="color: #0000ff">print</span> ip_src + &quot;<span style="color: #8b0000"> has been hijacking !!! debug info : </span>&quot; + str(ip_ttl) + &quot;<span style="color: #8b0000"> &lt;-&gt; </span>&quot; + str(ip_arr[ip_src])<br><br><span style="color: #0000ff">else</span>:<br><br>ip_arr[ip_src] = ip_ttl<br><br><span style="color: #0000ff">print</span> &quot;<span style="color: #8b0000">=&gt;</span>&quot;</pre><br><br><p>检测到某些设备拦截笔者在Google搜索敏感关键字的链路劫持：</p>

<p><a href="http://img.cker.in/df83baa6d2dd_D57E/clip_image004.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="clip_image004" border="0" alt="clip_image004" src="http://img.cker.in/df83baa6d2dd_D57E/clip_image004_thumb.png" width="590" height="212"></a></p>

<p>双向RST的情况，部署在机房的IDS也可以发现端倪。</p>

<p>如果是替换页面型攻击，页面hash或者HTML元素个数会有异常，这里也可以作为一个检测点。</p>

<p>防范链路劫持就比较困难，毕竟攻击者控制着网络链路。不过并非不可能。</p>

<p>一是网站全程使用SSL。</p>

<p>再一个就是在客户端或（和）服务器丢弃伪造的TCP包。比如前面说到的单向中断访问型攻击，就可以丢弃包含伪造特征的TCP包（如Id为0或8888）。某些项目就是利用客户端、服务端同时丢弃的方式来翻墙的。</p>

<p>最后，我们可以看到广域网一点都不安全，所以敏感信息传输一定要加密，还要高强度加密；高端网页最好有个校验机制；自动升级的程序也一定要校验文件签名。</p>

<p>原文：<a href="http://security.tencent.com/index.php/blog/msg/10" target="_blank" rel="external">http://security.tencent.com/index.php/blog/msg/10</a></p>
    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Secer</h4>
    <p>记录互联网安全历程与个人成长经历</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=记录互联网安全历程与个人成长经历 ?url=http://ha.cker.in/949.seo/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://ha.cker.in/949.seo/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://ha.cker.in/949.seo/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://ha.cker.in/949.seo/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/950.seo/">
        ← 最新FCKEditor ASP上传绕过漏洞
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/948.seo/">
        从Jannock渗透小米科技(xiaomi.com)说起 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Blog of Secer</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archives"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
