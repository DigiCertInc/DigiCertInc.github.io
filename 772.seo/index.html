<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>记一次不同寻常的网站渗透测试过程，上传基于time（） | Blog of Secer</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="Blog of Secer">

  
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Blog of Secer</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2012-08-30T11:24:47.000Z" itemprop="datePublished">
          2012-08-30
      </time>
    
    
    | 
    <a href='/tag/渗透/'>渗透</a>,
    
    <a href='/tag/爆路径/'>爆路径</a>
    
    
</span>
    <h1 class="post-title">记一次不同寻常的网站渗透测试过程，上传基于time（）</h1>
    <section class="post-content">
      <p>发现注入点：   <br><a href="http://www.xxx.com/xx.php?id=xxxx" target="_blank" rel="external">http://www.xxx.com/xx.php?id=xxxx</a>    <br>直接sqlmap脱库，发现有admin表，内容是显示的是账号admin密码admin，这时心里高兴了下，没加密。可是，曲折的在后面呢 ！管理后台很容易找到，直接上admin admin 可是，显示密码不对，怎么回事？？    <br>在看看数据库，翻遍数据库，账号密码也就这一个admin admin，（事实上也是这么回事） ，看看它登陆页面的源码吧，注入点能<a href="http://ha.cker.in/tag/爆路径" target="_blank">爆路径</a>，可以读出文件内容，直接读login.php 内容如下：    <br></p> <strong>&lt;?   <br> $filename = &quot;password.txt&quot;;    <br> $fd = fopen( $filename, &quot;r&quot; );    <br> $contents = fread($fd, filesize($filename));    <br> fclose( $fd );    <br> if($T1==&quot;admin&quot;){    <br>&#160;&#160;&#160;&#160; if($T2==$contents){    <br>&#160;&#160;&#160;&#160;&#160;&#160;&#160; setcookie(&quot;ad&quot;,&quot;$T1&quot;);    <br>&#160;&#160;&#160;&#160;&#160;&#160;&#160; header(&quot;location:editor/edit_index.php&quot;);    <br>&#160;&#160;&#160;&#160; }else{    <br>&#160;&#160;&#160;&#160; ?&gt;    <br>&#160;&#160;&#160;&#160;&#160; &lt;script language=&quot;javascript&quot;&gt;    <br>&#160;&#160;&#160;&#160;&#160; alert(&quot;密码错误&quot;);    <br>&#160;&#160;&#160;&#160;&#160; window.history.back();    <br>&#160;&#160;&#160;&#160;&#160; &lt;/script&gt;    <br>&#160;&#160;&#160;&#160; &lt;?    <br>&#160;&#160; }    <br> }else{    <br>&#160;&#160; ?&gt;    <br>&#160;&#160;&#160; &lt;script language=&quot;javascript&quot;&gt;    <br>&#160;&#160;&#160;&#160;&#160; alert(&quot;用户名错误&quot;);    <br>&#160;&#160;&#160;&#160;&#160; window.history.back();    <br>&#160;&#160;&#160;&#160;&#160; &lt;/script&gt;    <br>&#160;&#160; &lt;?    <br>&#160;&#160; }    <br>?&gt;</strong>  <p> 看到了吧！！！当时我就愣了一下，靠。。。。。。。。你妹的，怪不得找不到密码呢 好了，直接在域名后面加password.txt,密码出来了。 登陆后台页面，发现三个上传点，第一个是eweb3.8 （直接放弃），第二个上传点控制   <br>的非常死，各种变换都不行。还是第三个注入点有用，直接上传d,php,提示上传成功， 呵呵，上传是成功了，但是找不到路径，找啊找就是找不到路径。。晕啊。。。。。。。。。 找上传图片的路径，这时在读处理上传的php代码，代码如下    <br></p>  <p><strong>&lt;?     <br>if($_FILES[‘sytp’][‘name’]!=&quot;none&quot;&amp;&amp;$_FILES[‘sytp’][‘name’]!=&quot;&quot;){//判断上传文件是否为空      <br>$thistype=$_FILES[‘sytp’][‘type’];//将上传的类型传给$thistype      <br>//echo time().$_FILES[‘sytp’][‘name’];      <br>//exit;      <br>if(&quot;image/pjpeg&quot;==$thistype or &quot;application/x-shockwave-flash&quot;==$thistype or &quot;image/gif&quot;==$thistype){//判断是否是我要的类型      <br>&#160; $file_name = &quot;shouyetupian/&quot;.time().$_FILES[‘sytp’][‘name’];//time()是为了区分两个文件不是同一时间传的      <br>include(&quot;../connect.php&quot;);//调用connect.php里的内容      <br>$sql=&quot;select count(*) from shangchuantu&quot;;      <br>$result=mysql_query($sql,$db);      <br>$jie=mysql_fetch_row($result);      <br>$zhong=$jie[0];      <br>if($zhong&lt;5){      <br>$sql1=&quot;select max(paixu) from shangchuantu&quot;;      <br>&#160; $result1=mysql_query($sql1,$db);      <br> $jie1=mysql_fetch_row($result1);      <br> $zhong1=$jie1[0];      <br>$zhong1=$zhong1+1;      <br>&#160; $query=&quot;insert into shangchuantu values(‘’,’$file_name’,’&quot;.$_POST[‘url’].&quot;’,’’,’$zhong1’)&quot;;      <br>&#160; mysql_query($query,$db); </strong></p>  <p><strong>&#160; if(!move_uploaded_file($_FILES[‘sytp’][‘tmp_name’], $file_name)) {//上传文件，$_FILES[‘sctb’][‘tmp_name’]临时目录传到$file_name实际目录     <br> ?&gt;      <br>&#160; &lt;script language=&quot;javascript&quot;&gt;      <br>&#160; alert(&quot;文件上传失败，请稍候再试&quot;);      <br>&#160; window.history.back();      <br>&#160; &lt;/script&gt;      <br> &lt;?      <br>}else{//上传成功      <br>?&gt;      <br>&lt;script language=&quot;javascript&quot;&gt;      <br>alert(&quot;文件上传成功！&quot;);      <br>&#160; location.href=&quot;shanchuantu.php&quot;; </strong></p>  <p><strong>&lt;/script&gt;     <br>&lt;? </strong></p>  <p><strong>}     <br>}else{      <br>?&gt;      <br> &lt;script language=&quot;javascript&quot;&gt;      <br>&#160; alert(&quot;图片不能超过5张&quot;);      <br>&#160; window.history.back();      <br>&#160; &lt;/script&gt;      <br>&lt;?      <br>}      <br>}else{//如果类型不对      <br> ?&gt;      <br>&#160; &lt;script language=&quot;javascript&quot;&gt;      <br>&#160; alert(&quot;文件上传失败，请稍候再试&quot;);      <br>&#160; window.history.back();      <br>&#160; &lt;/script&gt;      <br> &lt;? </strong></p>  <p><strong>}     <br>}else{      <br>?&gt;      <br>&lt;script language=&quot;javascript&quot;&gt;      <br>&#160; alert(&quot;请选择上传图片&quot;);      <br>&#160; window.history.back();      <br>&#160; &lt;/script&gt;      <br>&lt;?      <br>}      <br>?&gt; </strong></p>  <p>&#160;</p>  <p>关键是file_name 是怎么形成的，   <br>$file_name = &quot;shouyetupian/&quot;.time().$_FILES[‘sytp’][‘name’];    <br>Time（） 返回自从Unix 纪元（格林威治时间1970 年1 月1 日00:00:00）到当前时间的秒数 比如你上传文件名为d.php,上传之后文件名为：&#160;&#160;&#160;&#160; 当前时间d.php 从代码页可以看出，是不返回上传后的文件名，这时怎么办，根据时间去碰文件名 本地搭建php服务器，echo 出time() 上传之前访问本地 <a href="http://127.0.0.1/time.php返回时间：1345279425" target="_blank" rel="external">http://127.0.0.1/time.php返回时间：1345279425</a> 这时快速的去目标网站去上传图片，多上传几个，道理你懂的，呵呵 上传完了之后在访问<a href="http://127.0.0.1/time.php" target="_blank" rel="external">http://127.0.0.1/time.php</a> 记下时间1345279475 相差50秒，也就是说上传的文件名在1345279425d.php—-1345279475d.php 之间.好吧，去碰吧。。。。。。。。。。。。。。。。。。。。。。。。。 碰啊碰。。。。。碰到了啊。。。。。。 菜刀连接，，成功！！！！！！！！！</p>
    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Secer</h4>
    <p>记录互联网安全历程与个人成长经历</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=记录互联网安全历程与个人成长经历 ?url=http://www.cker.in/772.seo/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://www.cker.in/772.seo/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.cker.in/772.seo/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.cker.in/772.seo/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/774.seo/">
        ← 利用XSS跨站漏洞入侵百度投诉中心用xss平台沦陷百度投诉中心后台
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/769.seo/">
        网易某系统未授权访问致内网被渗透 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Blog of Secer</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archive"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/2014-10-28-wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/2014-09-11-mabao/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
