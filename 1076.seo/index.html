<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Metasploit在Meterpreter中用开启肉鸡socks代理 | Blog of Secer</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="Blog of Secer">

  
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Blog of Secer</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2014-03-20T11:27:12.000Z" itemprop="datePublished">
          2014-03-20
      </time>
    
    
    | 
    <a href='/tag/meterpreter/'>meterpreter</a>,
    
    <a href='/tag/Metasploit/'>Metasploit</a>,
    
    <a href='/tag/nmap/'>nmap</a>,
    
    <a href='/tag/Nessus/'>Nessus</a>,
    
    <a href='/tag/proxychains/'>proxychains</a>
    
    
</span>
    <h1 class="post-title">Metasploit在Meterpreter中用开启肉鸡socks代理</h1>
    <section class="post-content">
      <p>USING METASPLOIT SOCKS PROXY AUXILIARY MODULE OVER A METERPRETER SESSION</p>  <p>During a penetration test , once you have compromised a machine on the internal network, the next step generally is to pivot and then scan, fingerprint exploit and compromise other hosts in the same internal network. Sometimes, it might be useful to tunnel all the TCP communications via a meterpreter session, and not just a single port or a group of ports. This can be achieved in <a href="http://ha.cker.in/tag/metasploit">Metasploit</a> using the socks proxy auxiliary module, which allows a pen-tester to tunnel TCP traffic generated by external programs like Nessus&#160; and Nmap to be tunneled via the socks proxy, which in-turn forwards the traffic via the <a href="http://ha.cker.in/tag/meterpreter" target="_blank">meterpreter</a> session , to the internal network that is not directly accessible. To force external programs to use the socks proxy, the pen-tester can use proxychains utility. Let’s, take an example:</p>  <p><a href="http://img.cker.in/MetasploitMeterpretersocks_2FF2/clip_image001.jpg" rel="external" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image001" border="0" alt="clip_image001" src="http://img.cker.in/MetasploitMeterpretersocks_2FF2/clip_image001_thumb.jpg" width="629" height="255"></a></p>  <p>In the above diagram the attacker has compromised HOST1 and has a meterpreter session number 1. First, to route the traffic destined to 192.168.168.0/24 network via this session he needs to issue the following command:</p>  <p>msf&gt; route add 192.168.158.0 255.255.255.0 1</p>  <p>The next step is to start the socks proxy form the metasploit and bind it to local loopback adapter on port 1080 (default port):</p>  <p>msf &gt; use auxiliary/server/socks4a</p>  <p>msf auxiliary(socks4a) &gt; set SRVHOST 127.0.0.1</p>  <p>msf auxiliary(socks4a) &gt; set SRVPORT 1080</p>  <p>msf auxiliary(socks4a) &gt; run</p>  <p>[<em>] Auxiliary module execution completed</em></p>  <p>[] Starting the socks4a proxy server</p>  <p>Now, the socks proxy server is listening on the loopback adapter on port 1080. The next step is to configure external tools and software like Firefox, nmap ,nessus etc. to use the proxy service configured.</p>  <p>In case of Firefox this can be done easily by clicking tools, options , network then settings. On the Connection setting tab one needs to choose Manual proxy configuration and Socks Host and Port should be set to 127.0.0.1 and 1080 respectively. The socks protocol should be set to SOCKSv4 as metasploit socks proxy only supports socks v4.</p>  <p><a href="http://img.cker.in/MetasploitMeterpretersocks_2FF2/clip_image002.jpg" rel="external" target="_blank"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="clip_image002" border="0" alt="clip_image002" src="http://img.cker.in/MetasploitMeterpretersocks_2FF2/clip_image002_thumb.jpg" width="257" height="284"></a></p>  <p>To tunnel <a href="http://ha.cker.in/tag/nmap" target="_blank">nmap</a> and <a href="http://ha.cker.in/tag/nessus" target="_blank">nessus</a> traffic via the <a href="http://ha.cker.in/tag/metasploit" target="_blank">metasploit</a> socks proxy, the pen-tester needs to use a tool called proxychains. First, step is to configure <a href="http://ha.cker.in/tag/proxychains" target="_blank">proxychains</a> to forwards the TCP traffic via the socks proxy setup earlier. This can be achieved by editing the /etc/proxychains.conf file and by adding the following lines :</p>  <p>socks4&#160; 127.0.0.1 1080</p>  <p>Finally, we can invoke/execute nessus like the following :</p>  <p># killall -9 nessusd</p>  <p># proxychains nessus-service –D</p>  <p>Now we can open a browser and point it to <a href="http://127.0.0.1:8834" target="_blank" rel="external">http://127.0.0.1:8834</a> and start the nessus scan. One important point to note here is that it is not possible to tunnel ICMP and UDP traffic via the socks proxy and hence ping packets and UDP scans should be omitted from the nessus scan list.</p>  <p>Similarly, it is possible to perform nmap scan via the socks proxy using the following command:</p>  <p># proxychains nmap –n –sT -sV -PN -p 80,22,443,445 192.168.168.2-254</p>  <p>As we can see the metasploit socks proxy auxillayr module is really handy and canhelp a lot during pivoting.</p>  <p>References :</p>  <p>[1] <a href="http://proxychains.sourceforge.net/howto.html" target="_blank" rel="external">http://proxychains.sourceforge.net/howto.html</a></p>  <p>[2] <a href="http://pauldotcom.com/2010/03/nessus-scanning-through-a-meta.html" target="_blank" rel="external">http://pauldotcom.com/2010/03/nessus-scanning-through-a-meta.html</a></p>
    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Secer</h4>
    <p>记录互联网安全历程与个人成长经历</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=记录互联网安全历程与个人成长经历 ?url=http://ha.cker.in/1076.seo/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://ha.cker.in/1076.seo/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://ha.cker.in/1076.seo/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://ha.cker.in/1076.seo/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/1077.seo/">
        ← 乐视渗透纪实
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/1074.seo/">
        用MetaSploit mimikatz模块获取Windows明文密码 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Blog of Secer</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archives"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
